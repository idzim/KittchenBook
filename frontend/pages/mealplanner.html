<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planer Posiłków | KitchenBook</title>
    <link rel="stylesheet" href="../css/reset.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>

    <main>
        <div class="container">
            <h2>Meal Planner</h2>
            <div class="btn-container">
                <button class="btn btn-primary" onclick="savePlan()">Zapisz Plan</button>
                <button class="btn btn-success" onclick="generateShoppingList()">Lista zakupów</button>
                <button class="btn btn-outline-secondary" onclick="resetPlan()">Resetuj</button>
            </div>
        </div>
        <div class="container">
            <div class="day-list" id="day-list"></div>
        </div>
    </main>

    <!-- Modal dla listy zakupów -->
    <div class="modal fade" id="shoppingListModal" tabindex="-1" aria-labelledby="shoppingListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shoppingListModalLabel">Lista Zakupów</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
                </div>
                <div class="modal-body">
                    <pre id="shoppingListContent" class="form-control" style="min-height: 200px;"></pre>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                    <button class="btn btn-primary" onclick="copyShoppingList()">Kopiuj do schowka</button>
                </div>
            </div>
        </div>
    </div>

     <!-- Bootstrap JavaScript (MUST HAVE for hamburger menu to work) -->
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
     
    <!-- Załadowanie main.js, który doda layout (header, nawigacja, footer) -->
    <script type="module" src="../js/main.js" defer></script>

    <script>
        let days = JSON.parse(localStorage.getItem("mealPlan")) || [
            { day: "Poniedziałek", meals: [] },
            { day: "Wtorek", meals: [] },
            { day: "Środa", meals: [] },
            { day: "Czwartek", meals: [] },
            { day: "Piątek", meals: [] },
            { day: "Sobota", meals: [] },
            { day: "Niedziela", meals: [] }
        ];

        let recipes = [];

        async function loadRecipes() {
            try {
                const response = await fetch("/api/recipes");
                if (!response.ok) throw new Error("Błąd pobierania przepisów");
                recipes = await response.json();
                renderDays(); // odpala tylko po pobraniu przepisów
            } catch (err) {
                console.error(err);
                alert("Nie udało się pobrać przepisów");
            }
        }
        loadRecipes();

        function renderDays() {
            const dayList = document.getElementById("day-list");
            dayList.innerHTML = "";
            
            days.forEach((day, index) => {
                let dayTile = document.createElement("div");
                dayTile.classList.add("day-tile");
                let mealOptions = recipes.map(recipe => `<option value='${JSON.stringify(recipe)}'>${recipe.name}</option>`).join('');
                
                dayTile.innerHTML = `
                    <h3>${day.day}</h3>
                    <div class='meals'>
                        ${day.meals.map(meal => ` 
                            <div class='meal-tile'>
                                <div class='meal-name'>${meal.name}</div>
                                <a href='${meal.link}' target='_blank' class='meal-recipe'>Zobacz przepis</a>
                            </div>
                        `).join('')}
                    </div>
                    <div class='add-recipe'>
                        <select onchange='addRecipe(${index}, this)'>
                            <option value=''>+ Dodaj Przepis</option>
                            ${mealOptions}
                        </select>
                        <button class="btn btn-sm btn-outline-primary mb-2" onclick="generateShoppingListForDay(${index})">Lista zakupów</button>
                    </div>
                `;
                dayList.appendChild(dayTile);
            });
        }

        function addRecipe(dayIndex, selectElement) {
            let selectedRecipe = JSON.parse(selectElement.value);
            if (selectedRecipe) {
                days[dayIndex].meals.push(selectedRecipe);
                savePlan();
                renderDays();
            }
        }

        function savePlan() {
            localStorage.setItem("mealPlan", JSON.stringify(days));
            alert("Plan posiłków zapisany!");
        }

        function resetPlan() {
            localStorage.removeItem("mealPlan");
            location.reload();
        }

        function generateShoppingList() {
            const allIngredients = {};

            days.forEach(day => {
                day.meals.forEach(meal => {
                    meal.ingredients?.forEach(ingredient => {
                        const key = `${ingredient.name} (${ingredient.unit || "-"})`;
                        if (!allIngredients[key]) {
                            allIngredients[key] = 0;
                        }
                        allIngredients[key] += ingredient.amount || 0;
                    });
                });
            });

            if (Object.keys(allIngredients).length === 0) {
                alert("Brak składników do wyświetlenia.");
                return;
            }

            const list = Object.entries(allIngredients)
              .map(([key, amount]) => `${key}: ${amount}`)
              .join('\n');

            // Wyświetlenie w modalu
            document.getElementById("shoppingListContent").textContent = list;
            const modal = new bootstrap.Modal(document.getElementById("shoppingListModal"));
            modal.show();
        }

        function generateShoppingListForDay(dayIndex) {
            const day = days[dayIndex];
            const allIngredients = {};

            day.meals.forEach(meal => {
                meal.ingredients?.forEach(ingredient => {
                    const key = `${ingredient.name} (${ingredient.unit || "-"})`;
                    if (!allIngredients[key]) {
                        allIngredients[key] = 0;
                    }
                    allIngredients[key] += ingredient.amount || 0;
                });
            });

            if (Object.keys(allIngredients).length === 0) {
                alert("Brak składników do wyświetlenia.");
                return;
            }

            const list = Object.entries(allIngredients)
              .map(([key, amount]) => `${key}: ${amount}`)
              .join('\n');

            document.getElementById("shoppingListContent").textContent = `Zakupy dla: ${day.day}\n\n` + list;
            const modal = new bootstrap.Modal(document.getElementById("shoppingListModal"));
            modal.show();
        }
        function copyShoppingList() {
            const content = document.getElementById("shoppingListContent").textContent;
            navigator.clipboard.writeText(content)
              .then(() => alert("Skopiowano do schowka!"))
              .catch(() => alert("Nie udało się skopiować."));
        }

        renderDays();
    </script>

</body>
</html>
